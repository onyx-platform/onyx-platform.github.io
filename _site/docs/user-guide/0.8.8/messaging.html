<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Messaging</title>
  <meta name="description" content="Distributed, masterless, high performance, fault tolerant data processing
">

  <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-72807409-1', 'auto');
	  ga('send', 'pageview');
  </script>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/lavish-bootstrap.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/cheat-sheet-style.css">
  <link rel="canonical" href="http://www.onyxplatform.org/docs/user-guide/0.8.8/messaging.html">
  <link rel="alternate" type="application/rss+xml" title="Onyx" href="http://www.onyxplatform.org/feed.xml" />
</head>



  <body>
    <header class="site-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-2"></div>
      <div class="col-md-1">
        <h2><a id="nav-title" href="/">Onyx</a></h2>
      </div>
      <div class="col-md-1"></div>
      <div class="col-md-6">
        <ul class="nav nav-pills navbar-right">
          <li class="nav-choice" role="presentation"><a href="/learn">learn</a></li>
          <li class="nav-choice" role="presentation"><a href="/docs">docs</a></li>
          <li class="nav-choice" role="presentation"><a href="/tools">tools</a></li>
          <li class="nav-choice" role="presentation"><a href="/blog">blog</a></li>
          <li class="nav-choice" role="presentation"><a href="https://github.com/onyx-platform/onyx">github</a></li>
          <li class="nav-choice" role="presentation"><a href="/support">support</a></li>
          <li class="nav-choice" role="presentation"><a href="/team">team</a></li>
        </ul>
      </div>
      <div class="col-md-2"></div>
    </div>
  </div>
</header>

    <div class="container-fluid">
  <div class="row">
    <div class="col-md-2 panel page-contents">
      <h4>Contents</h4>
      <ul>
  <li><a href="/docs/cheat-sheet/0.8.8">cheat sheet</a></li>
  <li><a href="/docs/api/0.8.8">api docs</a></li>
  <li>user guide</li>
  <ul>
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/aggregation-state-management.html">Aggregation and State</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/apis.html">APIs</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/architecture-low-level-design.html">Architecture</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/backpressure.html">Backpressure</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/concepts.html">Concepts</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/core-async-plugin.html">core.async Plugin</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/deployment.html">Deployment</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/environment.html">Environment</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/examples.html">Examples</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/faq.html">FAQ</a></li>
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/flow-conditions.html">Flow Conditions</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/functions.html">Functions</a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/information-model.html">Information Model</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/lifecycles.html">Lifecycles</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/logging.html">Logging</a></li>
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/messaging.html">Messaging</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/monitoring.html">Monitoring</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/peer-config.html">Peer Configuration</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/performance-tuning.html">Performance Tuning</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/plugins.html">Plugins</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/production-check-list.html">Production Checklist</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/scheduling.html">Scheduling</a></li>
    
    
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/subscription.html">Subscription</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/testing-onyx-jobs.html">Testing Onyx Jobs</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/triggers.html">Triggers</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/what-does-it-offer.html">What does it Offer?</a></li>
    
    
    
    <li class="docs-section"><a href="/docs/user-guide/0.8.8/windowing.html">Windowing</a></li>
    
    
  </ul>
</ul>

    </div>
    <div class="col-md-1"></div>
    <div class="col-md-7 panel">
      <h2 id="messaging">Messaging</h2>

<h3 id="background">Background</h3>

<p>The messaging layer takes care of the direct peer to peer transfer of segment
batches, acks, segment completion and segment retries to the relevant virtual
peers. The messaging layer design document can be found at the
<a href="/docs/user-guide/0.8.8/messaging.html">Messaging section</a>.</p>

<h3 id="messaging-implementations">Messaging Implementations</h3>

<p>The Onyx messaging implementation is pluggable and alternative implementations
can be selected via the <code>:onyx.messaging/impl</code> <a href="/docs/user-guide/0.8.8/peer-config.html">peer-config</a>.</p>

<h4 id="aeron-messaging">Aeron Messaging</h4>

<p>Owing to <a href="https://github.com/real-logic/Aeron">Aeron&#39;s</a> high throughput and low
latency, Aeron is the default Onyx messaging implementation. There are a few
relevant considerations when using the Aeron implementation.</p>

<h5 id="subscription-(connection)-multiplexing">Subscription (Connection) Multiplexing</h5>

<p>One issue when scaling Onyx to a many node cluster is that every virtual peer
may require a communications channel to any other virtual peer. As a result, a
naive implementation will require up to m<sup>2</sup> connections over the
cluster, where m is the number of virtual peers. By sharing Aeron subscribers
between virtual peers on a node, this can be reduced to n<sup>2</sup>
connections, where n is the number of nodes. This reduces the amount of
overhead required to maintain connections between peers, allowing the
cluster to scale better as the number of nodes to increase.</p>

<p>It is worth noting that Aeron subscribers (receivers) must also generally
perform deserialization.  Therefore, subscribers may become CPU bound by the
amount of deserializaton work that needs to be performed. In order to reduce
this effect, multiple subscribers can be instantiated per node.  This can be
tuned via <code>:onyx.messaging.aeron/subscriber-count</code> in
<a href="/docs/user-guide/0.8.8/peer-config.html">peer-config</a>. As increasing
the number of subscribers may lead back to an undesirable growth in the number
of connections between nodes, each node will only choose one subscription to
communicate through. The choice of subscriber is calculated via a hash of the combined IPs of the
communicating nodes, in order to consistently spread the use of subscribers over the cluster.</p>

<p>Clusters which perform a large proportion of the time serializing should
consider increasing the subscriber count. As a general guide, <code># cores = #
virtual peers + # subscribers</code>.</p>

<h5 id="connection-short-circuiting">Connection Short Circuiting</h5>

<p>When virtual peers are co-located on the same node, messaging will bypass the
use of Aeron and directly communicate the message without any use of the
network and without any serialization. Therefore, performance benchmarks
performed on a single node can be very misleading.</p>

<p>The <a href="/docs/user-guide/0.8.8/peer-config.html">peer-config</a> option, <code>:onyx.messaging/allow-short-circuit?</code>
is provided for the purposes of more realistic performance testing on a single node.</p>

<h5 id="port-use">Port Use</h5>

<p>The Aeron messaging implementation will use the port configured via
<code>:onyx.messaging/peer-port</code>. This <em>UDP port</em> must be unfirewalled.</p>

<h5 id="media-driver">Media Driver</h5>

<p>Aeron requires a media driver to be used on each node. Onyx provides an
embedded media driver for local testing, however use of the embedded driver is
not recommended in production. The embedded driver can be configured via the
<code>:onyx.messaging.aeron/embedded-driver?</code> <a href="/docs/user-guide/0.8.8/peer-config.html">peer-config</a> option.</p>

<p>When using Aeron messaging in production, a media driver should be created in
another java process. You can do this via the following code snippet, or by using the <a href="https://github.com/real-logic/Aeron#media-driver-packaging">Aeron distribution</a>.</p>
<div class="highlight"><pre><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="kd">ns </span><span class="nv">your-app.aeron-media-driver</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.core.async</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">chan</span> <span class="nv">&lt;!!</span><span class="p">]])</span>
  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">uk.co.real_logic.aeron</span> <span class="nv">Aeron$Context</span><span class="p">]</span>
           <span class="p">[</span><span class="nv">uk.co.real_logic.aeron.driver</span> <span class="nv">MediaDriver</span> <span class="nv">MediaDriver$Context</span> <span class="nv">ThreadingMode</span><span class="p">]))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">ctx</span> <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">MediaDriver$Context.</span><span class="p">))</span>
        <span class="nv">media-driver</span> <span class="p">(</span><span class="nf">MediaDriver/launch</span> <span class="nv">ctx</span><span class="p">)]</span>
    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Launched the Media Driver. Blocking forever...&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">&lt;!!</span> <span class="p">(</span><span class="nf">chan</span><span class="p">))))</span>
</code></pre></div>
<h5 id="configuration-options">Configuration Options</h5>

<p>Aeron is independently configurable via Java properties (e.g.  <code>JAVA_OPTS=&quot;-Daeron.mtu.length=16384&quot;</code>).
Configuration of these may cause different performance characteristics, and
certain options may need to be configured in order to communicate large segments between peers.</p>

<p>Documentation for these configuration options can be found in
<a href="https://github.com/real-logic/Aeron/wiki/Configuration-Options">Aeron&#39;s documentation</a>.</p>

    </div>
  </div>
</div>


    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <small><center>Copyright Â© Distributed Masonry 2016</center></small>
    </div>

  </div>

</footer>

  </body>

</html>
